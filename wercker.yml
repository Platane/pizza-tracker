box: node:6

bundle-lambda:
    steps:
        - script:
            cwd: back
            name: install dependencies
            code: |
                export YARN_CACHE=$WERCKER_CACHE_DIR/yarn
                HOME=$YARN_CACHE yarn --pure-lockfile

        - script:
            name: install zip
            code: |
                sudo apt-get update -y
                sudo apt-get install -y zip

        - script:
            cwd: back
            name: bundle
            code: |
                mkdir bundle
                ./node_modules/.bin/babel --presets flow,es2015,stage-1 --plugins transform-async-to-generator --out-dir ./bundle ./src

                cp ./package.json ./bundle/package.json
                cp ./yarn.lock ./bundle/yarn.lock
                cd bundle

                # yarn seems to install a bunch of devdependencies
                npm install --production --quiet
                rm package.json yarn.lock

                cd ..
                zip -r bundle.zip bundle


deploy-lambda:

    box: cgswong/aws

    steps:

        - script:
            cwd: back
            name: update lambda function
            code: |
                aws lambda update-function-code --region eu-west-1 --function-name pizza-update --zip-file fileb://bundle.zip
